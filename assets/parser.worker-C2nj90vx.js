(function(){"use strict";function f(r){const c=r.split(`
`),l=[];let t=null,a=!1;const n=new Map;for(const o of c){const s=o.match(/^(\S+)\s+(\d+)\s+\[(\d+)\]\s+([\d.]+):/);if(s){a=!0,t&&l.push(t);const e=s[1],i=parseInt(s[2]),m=parseInt(s[3]),p=n.get(m)||0,h=i-p;n.set(m,i),t={stack:[],time:parseFloat(s[4]),process:e,cpuCost:Math.max(0,h)}}else if(t&&o.trim()){const e=o.trim().split(" ")[1];if(e){let i=e.split("+")[0];i.startsWith("L")&&(i=i.substring(1).replace(/;/g,".")),t.stack.unshift(i)}}}if(t&&l.push(t),!a)throw new Error("Invalid file format: No sample headers found. Perf script output should contain lines with timestamps (e.g., 'command 1234 123.456:').");if(l.length===0)throw new Error("No complete samples could be parsed. Check that the file is not empty or truncated.");return l}function u(r){const c={name:"root",value:0,children:[],samples:[]};r.length>0&&(c.startTime=r[0].time,c.endTime=r[r.length-1].time);for(const t of r){let a=c;for(let n=0;n<t.stack.length;n++){let o=t.stack[n],s=t.process;if(o==="[unknown]"){let i=1;for(;n+1<t.stack.length&&t.stack[n+1]==="[unknown]";)i++,n++;i>1?o=`${i} x [unknown] (${s})`:o=`[unknown] (${s})`}let e=a.children.find(i=>i.name===o);e?(e.startTime&&e.startTime>t.time&&(e.startTime=t.time),e.endTime&&e.endTime<t.time&&(e.endTime=t.time)):(e={name:o,value:0,children:[],process:s,startTime:t.time,endTime:t.time,samples:[]},a.children.push(e)),n===t.stack.length-1&&(e.value++,e.samples=e.samples||[],e.samples.push({time:t.time,cpuCost:t.cpuCost})),a=e}}function l(t){const a=[{node:t,phase:"descend"}];for(;a.length>0;){const n=a[a.length-1];if(n.phase==="descend"){n.phase="process";for(const o of n.node.children)a.push({node:o,phase:"descend"})}else if(a.pop(),n.node.children.length>0){n.node.value=0;let o=1/0,s=-1/0;for(const e of n.node.children)e.startTime&&e.startTime<o&&(o=e.startTime),e.endTime&&e.endTime>s&&(s=e.endTime);n.node.startTime=o,n.node.endTime=s}}}return l(c),c.value=0,c}function d(r){if(r.length===0)return{data:[],maxTime:0,maxCount:0};const c=r[0].time,l=r[r.length-1].time-c,t=Math.ceil(l),a=Array.from({length:t},()=>Array(10).fill(0));let n=0;for(const s of r){const e=s.time-c,i=Math.floor(e),m=Math.floor((e-i)*10);i<t&&m<10&&(a[i][m]++,a[i][m]>n&&(n=a[i][m]))}const o=[];for(let s=0;s<t;s++)for(let e=0;e<10;e++)a[s][e]>0&&o.push({second:s,interval:e,count:a[s][e]});return{data:o,maxTime:t,maxCount:n,firstTime:c}}self.onmessage=r=>{const{fileContent:c}=r.data;try{const l=f(c),t=u(l),a=d(l);self.postMessage({status:"success",flamegraphData:t,heatmapData:a})}catch(l){console.error("Error parsing perf script:",l),self.postMessage({status:"error",message:l.message})}}})();
